<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script src="https://www.gstatic.com/firebasejs/5.6.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.6.0/firebase-database.js"></script>        
        <script src="https://www.gstatic.com/firebasejs/5.6.0/firebase.js"></script>
        <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDTMtuLlxOh1qnf4kgDXwMXGnfjKJjn6HE",
            authDomain: "mercstoria-97b64.firebaseapp.com",
            databaseURL: "https://mercstoria-97b64.firebaseio.com",
            projectId: "mercstoria-97b64",
            storageBucket: "mercstoria-97b64.appspot.com",
            messagingSenderId: "668675487672"
        };
        firebase.initializeApp(config);
        </script>
        <style>

            .ui-autocomplete
            {
                z-index: 9999 !important;
            }    
        </style>
        <script type="text/javascript" src="../script/const.js"></script>     
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>     
        <script type="text/javascript" src="../jquery/jquery-ui.min.js"></script>
        <script type="text/javascript" src="../bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="../jquery/jquery.maskMoney.js"></script>
        <link rel="stylesheet" href="../jquery/jquery-ui.min.css">
        <link rel="stylesheet" href="../css/card.css" >
        <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css" >
        <title>ギルドバトル戦績</title> 
        </head>
        <body>

    <!-- モーダルダイアログ -->
    <div class="modal fade" id="InputProcessDialog" tabindex="-1" role="dialog" aria-labelledby="modal" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title card-strong" id="demoModalTitle"><label id="when" ></label></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input id="input-guildBattleDate" style="margin-bottom:10px;" type="date"  requi2/>
                        <table class="table table-hover" style="width:100%;">
                            <tr><td><input type="text" placeholder="ギルド名" id="input-guildname-1"/></td><td><input type="text" placeholder="Gp" id="input-gp-1"/></tr>
                            <tr><td><input type="text" placeholder="ギルド名" id="input-guildname-2"/></td><td><input type="text" placeholder="Gp" id="input-gp-2"/></tr>
                            <tr><td><input type="text" placeholder="ギルド名" id="input-guildname-3"/></td><td><input type="text" placeholder="Gp" id="input-gp-3"/></tr>
                            <tr><td><input type="text" placeholder="ギルド名" id="input-guildname-4"/></td><td><input type="text" placeholder="Gp" id="input-gp-4"/></tr>
                        </table>
    
                        <textarea id="input-textarea-comment" placeholder="comment" style="width:90%;height: 150px;"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn card-buton" data-dismiss="modal" id="InputProcessSubmit">更新</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
                    </div>
                </div>
            </div>
        </div>
    
    <script>
            ////////////////////////////////////////////
            // 機能 : Date型を文字列に変換
            ////////////////////////////////////////////
            function convertToString(date)
            {
                return date.getFullYear() + "-" +
                    ( "0"+( date.getMonth()+1 ) ).slice(-2)+ "-" +
                    ( "0"+date.getDate() ).slice(-2);
                
            }
            ////////////////////////////////////////////
            // 機能 : 半角数字のみ入力
            ////////////////////////////////////////////
            function convertHalfCharacter(inputCharactger)
            {
                // 半角変換
                var halfVal = inputCharactger.replace(/[！-～]/g,
                        function (tmpStr) {
                            // 文字コードをシフト
                            return String.fromCharCode(tmpStr.charCodeAt(0) - 0xFEE0);
                        }
                    );
                // 数字以外の不要な文字を削除
                return halfVal.replace(/[^0-9,]/g, '');
            }
            ////////////////////////////////////////////
            // 機能 : UUIDを生成
            ////////////////////////////////////////////
            function generateUuid()
            {
                var uuid = "", i, random;
                for (i = 0; i < 32; i++) {
                    random = Math.random() * 16 | 0;

                    if (i == 8 || i == 12 || i == 16 || i == 20) {
                    uuid += "-"
                    }
                    uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
                }
                return uuid;
            }

        $(function(){
            ////////////////////////////////////////////
            // 機能 : 初期化
            ////////////////////////////////////////////
            $(document).ready(function()
            {
                var battleDate = localStorage.getItem(LOCALSTORAGE_KEY_GUILDBATTLE_DATE);
                if( battleDate == null )
                {
                    //子ダイアログ内のギルド日の日付を初期化
                    var now = new Date();
                    battleDate = convertToString(now);
                }
                $("#guildBattleDate").text(battleDate);
            });
        });

        ////////////////////////////////////////////
        // 機能 : 戦績入力モーダル表示時、親画面から引数を渡す
        ////////////////////////////////////////////
        $("#InputProcessDialog").on("show.bs.modal", function(event){
            // 起動ボタンから、入力引数を取得
            var raiseButton = $(event.relatedTarget);
            var when = raiseButton.data("when");

            var modal = $(this);
            modal.find("#when").text(when);
            $("#input-guildBattleDate").val($("#guildBattleDate").text());
        });

        ////////////////////////////////////////////
        // 機能 : オートコンプリート設定
        ////////////////////////////////////////////
        $("#input-guildname-1").on("input",function(){
            var guildName = $(this).val();
            showAutoCompliete(this.id, guildName);
        });
        $("#input-guildname-2").on("input",function(){
            var guildName = $(this).val();
            showAutoCompliete(this.id, guildName);
        });
        $("#input-guildname-3").on("input",function(){
            var guildName = $(this).val();
            showAutoCompliete(this.id, guildName);
        });
        $("#input-guildname-4").on("input",function(){
            var guildName = $(this).val();
            showAutoCompliete(this.id, guildName);
        });

        ////////////////////////////////////////////
        // 機能 : 入力値に応じて、データベースからギルド名を取得し、動的に補完
        ////////////////////////////////////////////
        function showAutoCompliete (controlId, inputword){
            // 最初の１文字を取得
            var word = inputword.charCodeAt(0);

            // データベースを検索
            var tableName = TABLE_GUILD_WORD + word;            
            var tableRef = firebase.database().ref(tableName);
            tableRef.once("value").then(function(snapshot){
                
                if( snapshot.val() == null )
                    return;

                // オートコンプリートの候補を表示
                var names = Object.values(snapshot.val());
                var autocompletelist = [];
                for( var name of names )
                    autocompletelist.push(name.name);

                console.log("オートコンプリートリスト : " + autocompletelist);
                $("#" + controlId).autocomplete({
                    source:autocompletelist,
                });                
            });            
        }
        ////////////////////////////////////////////
        // 機能 : 戦績入力モーダルの「Gp」入力制御
        ////////////////////////////////////////////
        $("#input-gp-1").on("input", function(){
            var character = convertHalfCharacter($(this).val());
            $(this).val(character);
        });
        $("#input-gp-2").on("input", function(){
            var character = convertHalfCharacter($(this).val());
            $(this).val(character);
        });
        $("#input-gp-3").on("input", function(){
            var character = convertHalfCharacter($(this).val());
            $(this).val(character);
        });
        $("#input-gp-4").on("input", function(){
            var character = convertHalfCharacter($(this).val());
            $(this).val(character);
        });

        // 3桁事に桁区切りを表示
        $("#input-gp-1").maskMoney({thousands:',',allowZero: true,precision: '0'});
        $("#input-gp-2").maskMoney({thousands:',',allowZero: true,precision: '0'});
        $("#input-gp-3").maskMoney({thousands:',',allowZero: true,precision: '0'});
        $("#input-gp-4").maskMoney({thousands:',',allowZero: true,precision: '0'});

        ////////////////////////////////////////////
        // 機能 : 戦績入力モーダルから更新ボタン押下時、子画面へデータを渡す
        ////////////////////////////////////////////
        $("#InputProcessSubmit").on("click",function(event){

            var battleDate = $("#input-guildBattleDate").val();
            if( battleDate == null )
            {
                alert("日付を入力してください。");
                return;
            } 
            $("#guildBattleDate").text( battleDate );
            localStorage.setItem(LOCALSTORAGE_KEY_GUILDBATTLE_DATE, battleDate);

            // ギルド名
            $(".guildname-1").text($("#input-guildname-1").val());
            $(".guildname-2").text( $("#input-guildname-2").val() );
            $(".guildname-3").text($("#input-guildname-3").val());
            $(".guildname-4").text($("#input-guildname-4").val());

            // gp
            var when = $("#when").text();
            var gp = when + "-gp-";
            $("#label-" + gp + "1").text(  $("#input-gp-1").val() );
            $("#label-" + gp + "2").text(  $("#input-gp-2").val() );
            $("#label-" + gp + "3").text(  $("#input-gp-3").val() );
            $("#label-" + gp + "4").text(  $("#input-gp-4").val() );

            // コメント
            var comment = when + "-comment";
            $("#textarea-" + comment).text($("#input-textarea-comment").val());

            var guildNames = [
                $("#input-guildname-1").val(),
                $("#input-guildname-2").val(),
                $("#input-guildname-3").val(),
                $("#input-guildname-4").val()
            ];

            for(var guildName of guildNames)
                registGuild(guildName);

        });
        function registGuild(guildName)
        {
            // 名前の一文字を取得
            var word = guildName.charCodeAt(0);

            var tableName = TABLE_GUILD_WORD;
            tableName +=  word;
            
            var tableRef = firebase.database().ref(tableName);
            tableRef.once("value").then(function(snapshot){

                if( snapshot.val() == null )
                {
                    tableRef.push({id : generateUuid(), name : guildName})
                    return;
                }

                var guild = Object.values(snapshot.val());
                var grepresult = $.grep(guild, function(entity,index){
                    return entity.name == guildName;
                });
                if( grepresult.length == 0 )
                {
                    tableRef.push({id : generateUuid(), name : guildName})
                }
            });                
        }

    </script>
    <div class="contanier">
        <p class="offset-lg-1" ><strong>日付</strong>
            <label id="guildBattleDate" width="100px"/>
        </p>
            <div class="row col-lg-10 offset-lg-1">
                <div class="col-lg-3">
                    <div class="card flex-md-row mb-4 box-shadow h-md-250" style="border-color : darkorchid; border-width:2px">
                        <div class="card-body d-flex flex-column align-items-start" >
                            <div style="width:100%">
                                <b class="d-inline-block mb-2 card-strong" >Moring</b> 
                                <input type="button" class="btn card-buton" style="float:right;" data-toggle="modal" data-when="morning" data-target="#InputProcessDialog" value="入力" />
                            </div>
                            <div class="table-responsive">
                                <table class="table" style="width:100%;">
                                    <tr><th>ギルド名</th> <th>GP</th></tr>
                                    <tr>
                                        <td><label class="guildname-1" id="label-morning-guildname-1"></label></td>
                                        <td><label id="label-morning-gp-1"></label><input type="hidden" class="guildid-1" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-2" id="label-morning-guildname-2"></label></td>
                                        <td><label id="label-morning-gp-2"></label><input type="hidden" class="guildid-2" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-3" id="label-morning-guildname-3"></label></td>
                                        <td><label id="label-morning-gp-3"></label><input type="hidden" class="guildid-3" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-4" id="label-morning-guildname-4"></label></td>
                                        <td><label id="label-morning-gp-4"></label><input type="hidden" class="guildid-4" /></td>
                                    </tr>
                                </table>
                            </div>
                            <textarea id="textarea-morning-comment" readonly="true" style="width:100%;height:150px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card flex-md-row mb-4 box-shadow h-md-250" style="border-color : darkorchid; border-width:2px">
                        <div class="card-body d-flex flex-column align-items-start" >
                            <div style="width:100%">
                                <b class="d-inline-block mb-2 card-strong" >Noon</b> 
                                <input type="button" class="btn card-buton" style="float:right;" data-toggle="modal" data-when="noon" data-target="#InputProcessDialog" value="入力" />
                            </div>
                            <div class="table-responsive">
                                <table class="table" style="width:100%;">
                                    <tr><th>ギルド名</th> <th>GP</th></tr>
                                    <tr>
                                        <td><label class="guildname-1" id="label-noon-guildname-1"></label></td>
                                        <td><label id="label-noon-gp-1"></label><input type="hidden" class="guildid-1" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-2" id="label-noon-guildname-2"></label></td>
                                        <td><label id="label-noon-gp-2"></label><input type="hidden" class="guildid-2" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-3" id="label-noon-guildname-3"></label></td>
                                        <td><label id="label-noon-gp-3"></label><input type="hidden" class="guildid-3" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-4" id="label-noon-guildname-4"></label></td>
                                        <td><label id="label-noon-gp-4"></label><input type="hidden" class="guildid-4" /></td>
                                    </tr>
                                    </table>
                            </div>
                            <textarea id="textarea-noon-comment" readonly="true" style="width:100%;height:150px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card flex-md-row mb-4 box-shadow h-md-250" style="border-color : darkorchid; border-width:2px">
                        <div class="card-body d-flex flex-column align-items-start" >
                            <div style="width:100%">
                                <b class="d-inline-block mb-2 card-strong" >Evening</b> 
                                <input type="button" class="btn card-buton" style="float:right;" data-toggle="modal" data-when="evening" data-target="#InputProcessDialog" value="入力" />
                            </div>
                            <div class="table-responsive">
                                <table class="table" style="width:100%;">
                                    <tr><th>ギルド名</th> <th>GP</th></tr>
                                    <tr>
                                        <td><label class="guildname-1" id="label-evening-guildname-1"></label></td>
                                        <td><label id="label-evening-gp-1"></label><input type="hidden" class="guildid-1" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-2" id="label-evening-guildname-2"></label></td>
                                        <td><label id="label-evening-gp-2"></label><input type="hidden" class="guildid-2" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-3" id="label-evening-guildname-3"></label></td>
                                        <td><label id="label-evening-gp-3"></label><input type="hidden" class="guildid-3" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-4" id="label-evening-guildname-4"></label></td>
                                        <td><label id="label-evening-gp-4"></label><input type="hidden" class="guildid-4" /></td>
                                    </tr>                                    
                                </table>
                            </div>
                            <textarea id="textarea-evening-comment" readonly="true" style="width:100%;height:150px;"></textarea>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card flex-md-row mb-4 box-shadow h-md-250" style="border-color : darkorchid; border-width:2px">
                        <div class="card-body d-flex flex-column align-items-start" >
                            <div style="width:100%">
                                <b class="d-inline-block mb-2 card-strong" >Night</b> 
                                <input type="button" class="btn card-buton" style="float:right;" data-toggle="modal" data-when="night" data-target="#InputProcessDialog" value="入力" />
                            </div>
                            <div class="table-responsive">
                                <table class="table" style="width:100%;">
                                    <tr><th>ギルド名</th> <th>GP</th></tr>
                                    <tr>
                                        <td><label class="guildname-1" id="label-night-guildname-1"></label></td>
                                        <td><label id="label-night-gp-1"></label><input type="hidden" class="guildid-1" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-2" id="label-night-guildname-2"></label></td>
                                        <td><label id="label-night-gp-2"></label><input type="hidden" class="guildid-2" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-3" id="label-night-guildname-3"></label></td>
                                        <td><label id="label-night-gp-3"></label><input type="hidden" class="guildid-3" /></td>
                                    </tr>
                                    <tr>
                                        <td><label class="guildname-4" id="label-night-guildname-4"></label></td>
                                        <td><label id="label-night-gp-4"></label><input type="hidden" class="guildid-4" /></td>
                                    </tr>                                    
                                    </table>
                            </div>
                            <textarea id="textarea-night-comment" readonly="true" style="width:100%;height:150px;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </body>
</html>